<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sensor Noise Chart - Static Example</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f8f9fa; }
    canvas { background: white; border-radius: 10px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h2>Noise Graph for Sensor (D 4 Example)</h2>
  <canvas id="noiseChart" width="1000" height="400"></canvas>

  <script>
  const sensorId = new URLSearchParams(window.location.search).get("sensor") || "94448";
  const apiUrl = `https://data.sensor.community/airrohr/v1/sensor/${sensorId}/`;

  fetch(apiUrl)
    .then(res => res.json())
    .then(data => {
      const now = new Date();
      const timeLimit = now.getTime() - 24 * 60 * 60 * 1000;

      const labels = [], eqValues = [], minValues = [], maxValues = [];

      data.forEach(entry => {
        const ts = new Date(entry.timestamp);
        if (ts.getTime() >= timeLimit) {
          const vs = entry.sensordatavalues;
          const eq = vs.find(v => v.value_type === "noise_LAeq");
          const min = vs.find(v => v.value_type === "noise_LA_min");
          const max = vs.find(v => v.value_type === "noise_LA_max");
          if (eq && min && max) {
            labels.push(ts);
            eqValues.push(parseFloat(eq.value));
            minValues.push(parseFloat(min.value));
            maxValues.push(parseFloat(max.value));
          }
        }
      });

      if (labels.length === 0) {
        alert("No valid noise data in the last 24h.");
        return;
      }

      function generateNightShading() {
        const nightShades = {};
        const start = new Date(labels[0]);
        const end = new Date(labels[labels.length - 1]);
        const msPerHour = 60 * 60 * 1000;
        for (let t = new Date(start); t < end; t = new Date(t.getTime() + msPerHour)) {
          const hour = t.getHours();
          if (hour >= 22 || hour < 7) {
            const id = `night-${t.toISOString()}`;
            const xMin = new Date(t);
            const xMax = new Date(t.getTime() + msPerHour);
            nightShades[id] = {
              type: "box",
              xMin, xMax,
              backgroundColor: "rgba(173, 216, 230, 0.2)",
              borderWidth: 0
            };
          }
        }
        return nightShades;
      }

      const ctx = document.getElementById("noiseChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "LAeq (dB)",
              data: eqValues,
              borderColor: "#007bff",
              fill: false,
              pointRadius: 0,
              tension: 0
            },
            {
              label: "LA_min",
              data: minValues,
              borderColor: "#28a745",
              borderDash: [4, 2],
              fill: false,
              pointRadius: 0,
              tension: 0
            },
            {
              label: "LA_max",
              data: maxValues,
              borderColor: "#dc3545",
              borderDash: [4, 2],
              fill: false,
              pointRadius: 0,
              tension: 0
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              type: "time",
              time: { unit: "hour", displayFormats: { hour: "HH:mm" } },
              title: { display: true, text: "Time" }
            },
            y: {
              title: { display: true, text: "Noise Level (dB)" },
              min: 30, max: 90
            }
          },
          plugins: {
            annotation: {
              annotations: {
                nightLimit: {
                  type: "line",
                  yMin: 45,
                  yMax: 45,
                  borderColor: "blue",
                  borderWidth: 1,
                  label: {
                    enabled: true,
                    content: "Night Limit 45 dB",
                    position: "start"
                  },
                  xMin: labels[0],
                  xMax: labels[labels.length - 1]
                },
                dayLimit: {
                  type: "line",
                  yMin: 70,
                  yMax: 70,
                  borderColor: "red",
                  borderWidth: 1,
                  label: {
                    enabled: true,
                    content: "Day Limit 70 dB",
                    position: "start"
                  },
                  xMin: labels[0],
                  xMax: labels[labels.length - 1]
                },
                ...generateNightShading()
              }
            }
          }
        },
        plugins: [Chart.registry.getPlugin("annotation")]
      });
    })
    .catch(err => {
      alert("Could not load sensor data.");
      console.error("Fetch error:", err);
    });
</script>


</body>
</html>
