<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sensor Noise Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f8f9fa; }
    canvas { background: white; border-radius: 10px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h2>Noise Graph for Sensor</h2>
  <canvas id="noiseChart" width="1000" height="400"></canvas>

  <script>
    const sensorId = new URLSearchParams(window.location.search).get("sensor") || "94448";
    const apiUrl = `https://data.sensor.community/static/v2/data.json?sensor=${sensorId}`;

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        const now = new Date();
        const timeLimit = now.getTime() - (24 * 60 * 60 * 1000); // 24h

        const labels = [];
        const values = [];

        data.forEach(entry => {
          const ts = new Date(entry.timestamp);
          if (ts.getTime() >= timeLimit) {
            const val = entry.sensordatavalues.find(v => v.value_type === "noise_LAeq");
            if (val) {
              labels.push(ts);
              values.push(parseFloat(val.value));
            }
          }
        });

        // ðŸ›  Move this function ABOVE usage
        function generateNightShading(timestamps) {
          const shades = {};
          timestamps.forEach((ts, i) => {
            const hour = new Date(ts).getHours();
            if (hour >= 22 || hour < 7) {
              const id = `shade-${i}`;
              shades[id] = {
                type: 'box',
                xMin: ts,
                xMax: timestamps[i + 1] || ts,
                backgroundColor: 'rgba(173, 216, 230, 0.15)',
                borderWidth: 0
              };
            }
          });
          return shades;
        }

        const ctx = document.getElementById("noiseChart").getContext("2d");
        const chart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "LAeq (dB)",
              data: values,
              borderColor: "#007bff",
              backgroundColor: "rgba(0,123,255,0.1)",
              fill: true,
              pointRadius: 0,
              tension: 0.2
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: {
                type: "time",
                time: { unit: "hour", displayFormats: { hour: 'HH:mm' } },
                title: { display: true, text: "Time" }
              },
              y: {
                title: { display: true, text: "Noise Level (dB)" },
                min: 30,
                max: 90
              }
            },
            plugins: {
              annotation: {
                annotations: {
                  dayLimit: {
                    type: 'line',
                    yMin: 70, yMax: 70,
                    borderColor: 'red', borderWidth: 1,
                    label: { enabled: true, content: 'Day Norm (70 dB)', position: 'start' }
                  },
                  nightLimit: {
                    type: 'line',
                    yMin: 45, yMax: 45,
                    borderColor: 'blue', borderWidth: 1,
                    label: { enabled: true, content: 'Night Norm (45 dB)', position: 'start' }
                  },
                  ...generateNightShading(labels)
                }
              }
            }
          },
          plugins: [window['chartjs-plugin-annotation']]
        });
      })
      .catch(err => {
        alert("Could not load sensor data.");
        console.error(err);
      });
  </script>
</body>
</html>
