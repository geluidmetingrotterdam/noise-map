<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sensor Noise Graph</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    canvas {
      width: 100%;
      height: 400px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Noise Graph for Sensor <span id="sensor-id">...</span></h1>
    <canvas id="chart"></canvas>
  </div>

  <script>
    const sensorId = new URLSearchParams(window.location.search).get("sensor") || "89747";
    document.getElementById("sensor-id").textContent = sensorId;

    const url = `https://data.sensor.community/airrohr/v1/sensor/${sensorId}/`;

    fetch(url)
  .then(res => res.json())
  .then(data => {
    const now = new Date();
    const timeLimit = now.getTime() - (24 * 60 * 60 * 1000); // last 24h

    const labels = [];
    const values = [];

    data.forEach(entry => {
      const ts = new Date(entry.timestamp);
      if (ts.getTime() >= timeLimit) {
        const valObj = entry.sensordatavalues.find(v => v.value_type === "noise_LAeq");
        if (valObj) {
          labels.push(ts);
          values.push(parseFloat(valObj.value));
        }
      }
    });

    if (values.length === 0) {
      throw new Error("No usable noise_LAeq data");
    }

    drawChart(labels, values); // or however you’re calling your chart function
  })
  .catch(err => {
    console.error("Error loading sensor data:", err);
    document.getElementById("status").innerText = "⚠️ Could not load sensor data.";
  });


        const ctx = document.getElementById("chart").getContext("2d");

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: "LAeq (dB)",
                data: values,
                borderColor: "#007bff",
                backgroundColor: "rgba(0,123,255,0.1)",
                fill: false,
                pointRadius: 0,
                borderWidth: 2
              },
              {
                label: "Day Norm (70 dB)",
                data: Array(values.length).fill(70),
                borderColor: "red",
                borderWidth: 1,
                borderDash: [5, 5],
                pointRadius: 0
              },
              {
                label: "Night Norm (45 dB)",
                data: Array(values.length).fill(45),
                borderColor: "orange",
                borderWidth: 1,
                borderDash: [5, 5],
                pointRadius: 0
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "hour",
                  displayFormats: {
                    hour: "HH:mm"
                  }
                },
                ticks: {
                  autoSkip: true,
                  maxTicksLimit: 12
                }
              },
              y: {
                suggestedMin: 30,
                suggestedMax: 90,
                title: {
                  display: true,
                  text: "dB"
                }
              }
            },
            plugins: {
              legend: { position: "bottom" },
              annotation: {
                annotations: [] // we'll simulate background shading next
              }
            },
            backgroundColor: 'white',
            animation: false
          },
          plugins: [{
            id: "nightBackground",
            beforeDraw: chart => {
              const ctx = chart.ctx;
              const chartArea = chart.chartArea;
              const { left, right, top, bottom } = chartArea;
              ctx.save();
              ctx.fillStyle = "rgba(173, 216, 230, 0.3)";

              const labelTimes = chart.data.labels;
              labelTimes.forEach((time, i) => {
                const hour = new Date(time).getHours();
                if (hour < 7 || hour >= 22) {
                  const x = chart.scales.x.getPixelForValue(labelTimes[i]);
                  const xNext = chart.scales.x.getPixelForValue(labelTimes[i + 1] || time);
                  ctx.fillRect(x, top, xNext - x, bottom - top);
                }
              });

              ctx.restore();
            }
          }]
        });
      })
      .catch(err => {
        console.error("Failed to load sensor data:", err);
        document.querySelector(".container").innerHTML = "<p>⚠️ Could not load sensor data.</p>";
      });
  </script>
</body>
</html>
