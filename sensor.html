<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sensor Noise Chart - Static Example</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f8f9fa; }
    canvas { background: white; border-radius: 10px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h2>Noise Graph for Sensor (D 4 Example)</h2>
  <canvas id="noiseChart" width="1000" height="400"></canvas>

 <script>
  const sensorId = new URLSearchParams(window.location.search).get("sensor") || "94448";
  const apiUrl = `https://data.sensor.community/airrohr/v1/sensor/${sensorId}/`;

  fetch(apiUrl)
    .then(res => res.json())
    .then(data => {
      const now = new Date();
      const timeLimit = now.getTime() - (24 * 60 * 60 * 1000); // 24h

      const labels = [];
      const values = [];

      data.forEach(entry => {
        const ts = new Date(entry.timestamp);
        if (ts.getTime() >= timeLimit) {
          const val = entry.sensordatavalues.find(v => v.value_type === "noise_LAeq");
          if (val) {
            labels.push(ts);
            values.push(parseFloat(val.value));
          }
        }
      });

      if (labels.length === 0 || values.length === 0) {
        alert("No noise_LAeq data found in last 24 hours.");
        return;
      }

      function generateNightShading(timestamps) {
        const shades = {};
        timestamps.forEach((ts, i) => {
          const hour = new Date(ts).getHours();
          if (hour >= 22 || hour < 7) {
            const id = `night-${i}`;
            shades[id] = {
              type: 'box',
              xMin: new Date(ts).toISOString(),
              xMax: new Date(timestamps[i + 1] || ts).toISOString(),
              backgroundColor: 'rgba(173, 216, 230, 0.2)',
              borderWidth: 0
            };
          }
        });
        return shades;
      }

      function generateNoiseLines(timestamps) {
        const lines = {};
        timestamps.forEach((ts, i) => {
          const hour = new Date(ts).getHours();
          const id = `line-${i}`;
          const x = new Date(ts).toISOString();
          const nextX = new Date(timestamps[i + 1] || ts).toISOString();
          const isNight = hour >= 22 || hour < 7;
          lines[id] = {
            type: 'line',
            xMin: x,
            xMax: nextX,
            yMin: isNight ? 45 : 70,
            yMax: isNight ? 45 : 70,
            borderColor: isNight ? 'blue' : 'red',
            borderWidth: 1,
            label: {
              display: false
            }
          };
        });
        return lines;
      }

      const ctx = document.getElementById("noiseChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "LAeq (dB)",
            data: values,
            borderColor: "#007bff",
            backgroundColor: "rgba(0,0,0,0)",
            fill: false,
            pointRadius: 0,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          animation: {
            duration: 800,
            x: { type: 'number', easing: 'linear' }
          },
          scales: {
            x: {
              type: "time",
              time: { unit: "hour", displayFormats: { hour: 'HH:mm' } },
              title: { display: true, text: "Time" }
            },
            y: {
              title: { display: true, text: "Noise Level (dB)" },
              min: 30,
              max: 90
            }
          },
          plugins: {
            annotation: {
              annotations: {
                ...generateNightShading(labels),
                ...generateNoiseLines(labels)
              }
            }
          }
        },
        plugins: [Chart.registry.getPlugin('annotation')]
      });
    })
    .catch(err => {
      alert("Could not load sensor data.");
      console.error("Fetch error:", err);
    });
</script>



</body>
</html>
